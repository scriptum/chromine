<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="utf-8" />
	<title>Сапёр</title>
	<style>
	body
	{
		-webkit-user-select:none;
		cursor:default
	}
	#info{float:right}
	#mode{float:left}
	#field
	{
		clear:both;
		padding:10px;
		text-align:center
	}
	#tile
	{
		margin:auto;
		border:2px solid #46a;
		border-collapse: collapse;
	}
	#tile td, input
	{
		box-shadow:inset 0px 1px 0px 0px #ace;
		background-color:#48c;
		background:-webkit-gradient(linear, left top, left bottom, color-stop(0.2, #6be), color-stop(0.8, #48c));
		border:1px solid #46a;
		color:#128;
		text-align:center;
		text-shadow: 1px 1px 3px #ace;
	}
	#tile td
	{
		height:30px;
		width:30px;
		font:18pt sans;
		padding:0;
	}
	#tile td[clr=c1]{color:#00f}
	#tile td[clr=c2]{color:#080}
	#tile td[clr=c3]{color:#e00}
	#tile td[clr=c4]{color:#008}
	#tile td[clr=c5]{color:#800}
	#tile td[clr=c6]{color:#808}
	#tile td[clr=c7]{color:#f80}
	#tile td[clr=c8]{color:#000}
	#tile td.mine{color:#e00;}
	#tile td.mine_bad{color:#e21;}
	#tile td.open, #tile td.over{background:#ace;}
	</style>
	<script>
		function $$(s){return [].slice.call(document.querySelectorAll(s))}
		function $(s){return document.querySelector(s)}
		function creat(e){return document.createElement(e)}
		function rnd(a, b){return Math.floor(Math.random()*(b-a+1))+a;}
		var flag = '⚑';
		var bomb = '☢';
		var game =
		{
			begin:false,
			tiles:[],
			x:32,
			y:16,
			mines:99,
			over:false,
			opened:0,
			mind_mode:false,
			auto_open:true
		}
		function o2xy(o)
		{
			var n = o.id.substr(1).split('_');
			return {x: parseInt(n[0]), y: parseInt(n[1])}
		}
		function xy2o(x, y)
		{
			return $('#t' + x + '_' + y);
		}
		function loop_near(f, x, y)
		{
			if(typeof(x) != 'number')
			{
				var n = o2xy(x);
				x = n.x;
				y = n.y;
			}
			function chk(f, x, y)
			{
				if(x >= 0 && x < game.x && y >= 0 && y < game.y)
					f(x, y, x + y * game.x);
			}
			chk(f,x-1,y-1);
			chk(f,x,y-1);
			chk(f,x+1,y-1);
			chk(f,x-1,y);
			chk(f,x+1,y);
			chk(f,x-1,y+1);
			chk(f,x+1,y+1);
			chk(f,x,y+1);
		}
		function mines_near(x, y, flags)
		{
			var mines = 0;
			if(flags)
				loop_near(function(x, y)
				{
					if(xy2o(x, y).innerHTML == flag)
						mines++;
				}, x, y);
			else
				loop_near(function(x, y, p)
				{
					if(game.tiles[p])
						mines++;
				}, x, y);
			return mines;
		}
		function loop_game(f)
		{
			for(var j = 0; j < game.y; j++)
				for(var i = 0; i < game.x; i++)
					f(i, j, i + j * game.x)
		}
		function open_tile(o, x, y)
		{
			if(game.end)
				return false;
			if(game.tiles[x + y * game.x])
			{
				game_over();
				o.setAttribute("class", "mine");
				return false;
			}
			if(game.begin)
			{
				game.begin = false;
				place_mines(x, y);
			}
			var mines = mines_near(x, y);
			if(game.mind_mode)
				var flags = mines_near(x, y, true);
			o.setAttribute("class", "open");
			if(mines == 0)
				open_near(x, y);
			else
			{
				if(game.mind_mode)
					o.innerHTML = mines - flags;
				else
					o.innerHTML = mines;
			}
			o.setAttribute("clr", "c" + o.innerHTML);
			game.opened++;
			if(game.opened == game.x * game.y - game.mines)
				victory()
			if(game.auto_open)
			{
				var mines = mines_near(x, y, true);
				if(xy2o(x, y).innerHTML == mines)
					open_near(x, y);
			}
		}
		function open_near(x, y)
		{
			loop_near(function(dx, dy)
			{
				var oo = xy2o(dx, dy);
				if(!isOpen(oo) && oo.innerHTML != flag)
					open_tile(oo, dx, dy);
			}, x, y);
		}
		function isOpen(o)
		{
			return o.getAttribute("class") == "open"
		}
		function game_end(is_over)
		{
			loop_game(function(x,y,p)
			{
				var o = xy2o(x, y);
				if(game.tiles[p])
				{
					if(o.innerHTML != flag)
					{
						if(game.over)
							o.innerHTML = bomb;
						else
							o.innerHTML = flag;
					}
				}
				else
				{
					if(o.innerHTML == flag)
						o.setAttribute("class", "mine_bad");
				}
			})
		}
		function victory()
		{
			game_end();
			alert('Победа! Вермя: ' + Math.floor((new Date() - game.time) / 100) / 10);
		}
		function game_over()
		{
			game.over = true;
			game.end = true;
			game_end();
		}
		function place_mines(x, y)
		{
			game.time = new Date();
			for(var m = 0; m < game.mines;)
			{
				var r_x = rnd(0, game.x - 1);
				var r_y = rnd(0, game.y - 1);
				var p = r_x + r_y * game.x;
				if(r_x == x && r_y == y || game.tiles[p])
					continue;
				game.tiles[p] = true;
				m++;
			}
		}
		function do_down(e)
		{
			if(game.end)
				return false;
			var o = e.target;
			if(isOpen(o))
			{
				loop_near(function(x, y)
				{
					var o = xy2o(x, y);
					if(!isOpen(o) && o.innerHTML != flag)
						o.classList.add('over');
				}, o);
			}
			var n = o2xy(o);
			if(e.button == 0)
			{
				if(o.innerHTML == flag)
					return false;
				if(isOpen(o))
				{
					var mines = mines_near(x, y);
					var c = parseInt(o.innerHTML);
					if(mines == c && !game.mind_mode || game.mind_mode && c == 0)
						open_near(n.x, n.y);
					return false;
				}
				open_tile(o, n.x, n.y);
			}
			else
			{
				if(isOpen(o))
					return false;
				var cnt = $('#mineinf');
				var mine_diff = 0;
				if(o.innerHTML != flag)
				{
					o.innerHTML = flag;
					cnt.innerHTML--;
					if(cnt.innerHTML == 0)
					{
						loop_game(function(i, j)
						{
							var o = xy2o(i, j);
							if(o.innerHTML != flag && !isOpen(o))
								open_tile(o, i, j);
						})
						if(!game.over)
							victory()
					}
					mine_diff = -1;
				}
				else
				{
					o.innerHTML = '';
					cnt.innerHTML++;
					mine_diff = 1;
				}
				loop_near(function(x,y,p)
				{
					var o = xy2o(x, y);
					if(isOpen(o))
					{
						if(game.mind_mode)
						{
							o.innerHTML = mine_diff + parseInt(o.innerHTML);
							o.setAttribute('clr', 'c' + o.innerHTML);
						}
						if(game.auto_open)
						{
							var mines = mines_near(x, y, true);
							if(xy2o(x, y).innerHTML == mines)
								open_near(x, y);
						}
					}
				}, o);
			}
			return false;
		}
		function do_up(e)
		{
			loop_game(function(x,y){xy2o(x,y).classList.remove('over')})
		}
		function start()
		{
			game.begin = true;
			game.end = false;
			game.over = false;
			game.opened = 0;
			loop_game(function(x,y,p){game.tiles[p] = false})
			$('#mineinf').innerHTML = game.mines;
			$('#fldinf').innerHTML = game.x + 'x' + game.y;
			var tbdy = creat('tbody');
			for(var i = 0; i < game.y; i++)
			{
				var tr = creat('tr');
				for(var j = 0; j < game.x; j++)
				{
					var td = creat('td');
					td.id = 't' + j + '_' + i;
					td.onmousedown = do_down;
					tr.appendChild(td);
				}
				tbdy.appendChild(tr);
			}
			$('#tile').appendChild(tbdy);
		}
		function start_button(e)
		{
			var o = e.target;
			var a = o.id.split('x');
			game.x = a[0];
			game.y = a[1];
			game.mines = a[2];
			$('#tile').removeChild($('#tile tbody'))
			$('#lvlinf').innerHTML = o.value;
			start();
		}
		function init()
		{
			$$('#mode input').forEach(function(e)
			{
				e.onclick = start_button
			});
			start();
			document.body.oncontextmenu = function(){return false};
			document.body.onmouseup = do_up;
		};
	</script>
</head>
<body onload="init()">
	<div id="mode">
		<input type="button" value="Новичок" id="8x8x10" />
		<input type="button" value="Продвинутый" id="16x16x40" />
		<input type="button" value="Профессионал" id="32x16x99" />
		<input type="button" value="Эксперт" id="60x30x400" />
	</div>
	<div id="info">
		<a id="lvlinf">Профессионал</a> <a id="fldinf"></a>, мин: <a id="mineinf"></a>.
	</div>
	<div id="field">
		<table id="tile"></table>
	</div>
</body>
</html>
