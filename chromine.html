<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="utf-8" />
	<title>Сапёр</title>
	<style>
	body
	{
		-webkit-user-select:none;
		cursor:default
	}
	#info{float:right}
	#mode{float:left}
	#field
	{
		clear:both;
		padding:10px;
		text-align:center
	}
	#tile
	{
		margin:auto;
		border:2px solid #46a;
		border-collapse: collapse;
	}
	#tile td, input
	{
		background-color:#48c;
		background:-moz-linear-gradient(top, #5ae 0%, #5ae 10%, #48c 70%);
		background:linear-gradient(to bottom, #5ae 0%, #5ae 10%, #48c 70%);
		border:1px solid #46a;
		color:#128;
		text-align:center;
		text-shadow: 1px 1px 3px #ace;
	}
	#tile td
	{
		height:30px;
		width:30px;
		font:18pt sans;
		padding:0;
	}
	#conf_window
	{
		background:#fff;
		position:absolute;
		width:50%;
		height:50%;
		left:25%;
		top:25%;
		margin:auto;
		border:5px solid #46a;
		border-radius:10px;
		box-shadow:0 0 0 5000px rgba(0,0,0,0.7);
		padding:10px;
		display:none;
	}
	#conf_window #close
	{
		cursor:pointer;
		float:right;
	}
	#tile td[clr=c1]{color:#00f}
	#tile td[clr=c2]{color:#080}
	#tile td[clr=c3]{color:#e00}
	#tile td[clr=c4]{color:#008}
	#tile td[clr=c5]{color:#800}
	#tile td[clr=c6]{color:#808}
	#tile td[clr=c7]{color:#f80}
	#tile td[clr=c8]{color:#000}
	#tile td.mine{color:#e00}
	#tile td.mine_bad{color:#e21}
	#tile td.open, #tile td.over{background:#ace}
	</style>
	<script>
		function $$(s){return [].slice.call(document.querySelectorAll(s))}
		function $(s){return document.querySelector(s)}
		function creat(e){return document.createElement(e)}
		function rnd(a, b){return Math.floor(Math.random()*(b-a+1))+a;}
		function getopt(o){return localStorage.getItem(o)}
		function setopt(o,v){return localStorage.setItem(o,v)}
		var flag = '⚑';
		var bomb = '☢';
		var game =
		{
			tiles:[],
			x:32,
			y:16,
			mines:99
		}
		function o2xy(o)
		{
			var n = o.id.substr(1).split('_');
			return {x: parseInt(n[0]), y: parseInt(n[1])}
		}
		function xy2o(x, y)
		{
			return $('#t' + x + '_' + y);
		}
		function loop_near(f, x, y)
		{
			if(typeof(x) != 'number')
			{
				var n = o2xy(x);
				x = n.x;
				y = n.y;
			}
			function chk(f, x, y)
			{
				if(x >= 0 && x < game.x && y >= 0 && y < game.y)
					f(x, y, x + y * game.x);
			}
			chk(f,x-1,y-1);
			chk(f,x,y-1);
			chk(f,x+1,y-1);
			chk(f,x-1,y);
			chk(f,x+1,y);
			chk(f,x-1,y+1);
			chk(f,x+1,y+1);
			chk(f,x,y+1);
		}
		function mines_near(x, y, flags)
		{
			var mines = 0;
			if(flags)
				loop_near(function(x, y)
				{
					if(xy2o(x, y).innerHTML == flag)
						mines++;
				}, x, y);
			else
				loop_near(function(x, y, p)
				{
					if(game.tiles[p])
						mines++;
				}, x, y);
			return mines;
		}
		function loop_game(f)
		{
			for(var j = 0; j < game.y; j++)
				for(var i = 0; i < game.x; i++)
					f(i, j, i + j * game.x)
		}
		function isOpen(o)
		{
			return o.getAttribute("class") == "open"
		}
		function open_near(x, y)
		{
			if(getopt('mind_mode') == 'true')
			{
				if(xy2o(x, y).innerHTML > 0)
					return;
			}
			else
			{
				if(xy2o(x, y).innerHTML != mines_near(x, y, true))
					return;
			}
			loop_near(function(x, y)
			{
				var o = xy2o(x, y);
				if(!isOpen(o) && o.innerHTML != flag)
					open_tile(o, x, y);
			}, x, y);
		}
		function open_auto(x, y)
		{
			if(getopt('auto_open') == 'true')
				open_near(x, y);
		}
		function game_end(is_over)
		{
			game.end = true;
			loop_game(function(x,y,p)
			{
				var o = xy2o(x, y);
				if(game.tiles[p])
				{
					if(o.innerHTML != flag)
					{
						if(game.over)
							o.innerHTML = bomb;
						else
							o.innerHTML = flag;
					}
				}
				else
				{
					if(o.innerHTML == flag)
						o.setAttribute("class", "mine_bad");
				}
			})
		}
		function victory()
		{
			if(game.end)
				return false;
			game_end();
			alert('Победа! Вермя: ' + Math.floor((new Date() - game.time) / 100) / 10);
			setTimeout(start, 500);
			return false;
		}
		function game_over()
		{
			game.over = true;
			game_end();
		}
		function place_mines(x, y)
		{
			game.time = new Date();
			for(var m = 0; m < game.mines;)
			{
				var r_x = rnd(0, game.x - 1);
				var r_y = rnd(0, game.y - 1);
				var p = r_x + r_y * game.x;
				if(r_x >= x - 1 && r_x <= x + 1 && r_y >= y - 1 && r_y <= y + 1 || game.tiles[p])
					continue;
				game.tiles[p] = true;
				m++;
			}
		}
		function recalcMines(o, x, y)
		{
			var mines = mines_near(x, y);
			if(getopt('mind_mode') == 'true')
				o.innerHTML = mines - mines_near(x, y, true);
			else
				o.innerHTML = mines;
			if(o.innerHTML == "0")
				o.innerHTML = "";
			o.setAttribute("clr", "c" + o.innerHTML);
		}
		function open_tile(o, x, y)
		{
			if(game.end || isOpen(o))
				return false;
			if(game.tiles[x + y * game.x])
			{
				o.setAttribute("class", "mine");
				game_over();
				return false;
			}
			if(game.begin)
			{
				game.begin = false;
				place_mines(x, y);
			}
			o.setAttribute("class", "open");
			recalcMines(o, x, y);
			game.opened++;
			if(game.opened == game.x * game.y - game.mines)
				return victory();
			open_near(x, y);
		}
		function do_down(e)
		{
			if(game.end)
				return false;
			var o = e.target;
			if(e.button == 0)
			{
				if(o.innerHTML == flag)
					return false;
				var n = o2xy(o);
				if(isOpen(o))
				{
					loop_near(function(x, y)
					{
						var oo = xy2o(x, y);
						if(!isOpen(oo) && oo.innerHTML != flag)
							oo.classList.add('over');
					}, o);
					open_near(n.x, n.y);
					return false;
				}
				open_tile(o, n.x, n.y);
			}
			else
			{
				if(isOpen(o))
					return false;
				var cnt = $('#mineinf');
				var mine_diff = 0;
				if(o.innerHTML != flag)
				{
					o.innerHTML = flag;
					cnt.innerHTML--;
					if(cnt.innerHTML == 0)
					{
						loop_game(function(i, j)
						{
							var o = xy2o(i, j);
							if(o.innerHTML != flag && !isOpen(o))
								open_tile(o, i, j);
						});
						if(!game.over)
							return victory();
					}
					mine_diff = -1;
				}
				else
				{
					o.innerHTML = '';
					cnt.innerHTML++;
					mine_diff = 1;
				}
				loop_near(function(x,y,p)
				{
					var o = xy2o(x, y);
					if(isOpen(o))
					{
						recalcMines(o, x, y);
						open_auto(x, y);
					}
				}, o);
			}
			return false;
		}
		function do_up(e)
		{
			loop_game(function(x,y){xy2o(x,y).classList.remove('over')})
		}
		function start()
		{
			game.begin = true;
			game.end = false;
			game.over = false;
			game.opened = 0;
			loop_game(function(x,y,p){game.tiles[p] = false})
			$('#tile').removeChild($('#tile tbody'));
			$('#mineinf').innerHTML = game.mines;
			$('#fldinf').innerHTML = game.x + 'x' + game.y;
			var tbdy = creat('tbody');
			for(var i = 0; i < game.y; i++)
			{
				var tr = creat('tr');
				for(var j = 0; j < game.x; j++)
				{
					var td = creat('td');
					td.id = 't' + j + '_' + i;
					td.onmousedown = do_down;
					tr.appendChild(td);
				}
				tbdy.appendChild(tr);
			}
			$('#tile').appendChild(tbdy);
		}
		function start_button(e)
		{
			var o = e.target;
			var a = o.id.split('x');
			game.x = a[0];
			game.y = a[1];
			game.mines = a[2];
			$('#lvlinf').innerHTML = o.value;
			start();
		}
		function init()
		{
			$$('#mode input').forEach(function(e)
			{
				e.onclick = start_button
			});
			start();
			var b = document.body;
			b.oncontextmenu = function(){return false};
			b.onmouseup = do_up;
			var s = {"auto_open":"Открывать соседние клетки по возможности","mind_mode":"Автоматически уменьшать вес поля после установки мин"};
			for(i in s)
			{
				if(getopt(i) == undefined)
					setopt(i, false);
				$('#conf_window').innerHTML += '<input type="checkbox" onchange="settings(this)" name="'+i+'"'+((getopt(i) == 'true') ? ' checked' : '')+'/> '+s[i]+' <br />';
			}
			$('#close').onmousedown = function(){$('#conf_window').style.display = 'none'}
			$('#conf').onmousedown = function(){$('#conf_window').style.display = 'block'}
		}
		function settings(e)
		{
			setopt(e.name, e.checked)
		};
	</script>
</head>
<body onload="init()">
	<div id="mode">
		<input type="button" value="Новичок" id="8x8x10" />
		<input type="button" value="Продвинутый" id="16x16x40" />
		<input type="button" value="Профессионал" id="32x16x99" />
		<input type="button" value="Эксперт" id="60x30x400" />
	</div>
	<div id="info">
		<a id="lvlinf">Профессионал</a> <a id="fldinf"></a>, мин: <a id="mineinf"></a>.
		<input type="button" value="⚙" id="conf" />
	</div>
	<div id="field">
		<table id="tile"><tbody></tbody></table>
	</div>
	<div id="conf_window">
		<div id="close">✖</div>
	</div>
</body>
</html>
